{% extends 'base.html' %}
{% load static %}

{% block title %}Create Post{% endblock %}

{% block main %}
    <form method="POST" action="{% url 'create_post' %}" class="form-group" id="app">
        {% csrf_token %}
        {% include 'errors.html' %}

        <div v-if="loading" class="spinner-border" role="status"></div>

        <div v-if="noSpaceIdParam" class="alert alert-primary" role="alert">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#084298"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
            <h5>Are you sure you want to create a post without a space? You won't be able to pick tags.</h5>
            <p>Browse spaces <a :href="generateURL()" class="link-primary">here</a>.</p>
        </div>

        <div v-else class="tags-space-container">
            <div class="card h-100">
                <img v-if="space.image" class="card-img-top" :src="space.image" alt="Card image cap">
                <img v-else class="card-img-top" src="{% static 'images/default-banner.png' %}" alt="Card image cap">

                <div class="card-body">
                    <h5 class="card-title">[[ space.name ]]</h5>
                    <p class="card-text">[[ space.description ]]</p>
                </div>
            </div>

            <div class="card-footer">
                <span v-for="tag in space.tags" :key="tag.id" @click="toggleTag(tag)" :class="getClass(tag.id)">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M840-480 666-234q-11 16-28.5 25t-37.5 9H200q-33 0-56.5-23.5T120-280v-400q0-33 23.5-56.5T200-760h400q20 0 37.5 9t28.5 25l174 246Zm-98 0L600-680H200v400h400l142-200Zm-542 0v200-400 200Z"/></svg>
                    [[ tag.name ]]
                </span>
                <br>
                <i><a href="">Load more spaces and tags.</a> (not recommended)</i>
                <hr class="hr" />
                {{ form.tags }}
                <i><h5>Tags selected: [[ tags.length ]]</h5></i>
            </div>
        </div>

        <div class="form-floating mb-3">
            {{ form.name }}
            <label for="name">Enter Name</label>
        </div>
        <div class="form-floating mb-3 form-content">
            {{ form.content }}
            <label for="content">Enter Content</label>
        </div>

        <div class="form-check form-switch">
            {{ form.visibility }}
            <label class="form-check-label" for="flexSwitchCheckDefault">
                <i v-html="message"></i>
            </label>
        </div>

        {{ form.space }}

        <button type="submit" class="btn btn-secondary">Publish</button>
    </form>
{% endblock %}

{% block rest %}
<script>
    axios.defaults.xsrfCookieName = 'csrftoken';
    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";

    new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            message: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/></svg> Public',
            isChecked: true,
            noSpaceIdParam: false,
            space: {},
            loading: true,
            name: '{{ name|default_if_none:"" }}',
            content: '{{ content|default_if_none:"" }}',
            spaceInput: null,
            tags: []
        },
        methods: {
            generateURL() {
                return `{% url 'list_spaces' %}?name=${this.name}&content=${this.content}`
            },
            toggleTag(tag) {
                const index = this.tags.indexOf(tag.id);
                if (index === -1) {
                    this.tags.push(tag.id);
                } else {
                    this.tags.splice(index, 1);
                }
            },
            isSelected(tagId) {
                return this.tags.includes(tagId);
            },
            getClass(tagId) {
                if (this.isSelected(tagId)) {
                    return 'badge me-2 bg-primary';
                } else {
                    return 'badge me-2 bg-secondary';
                }
            }
        },
        mounted() {
            const checkbox = document.getElementById('flexSwitchCheckDefault');
            checkbox.addEventListener('change', (event) => {
                this.isChecked = event.target.checked;
                this.message = this.isChecked ?
                    '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/></svg> Public' :
                    '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z"/></svg> Private';
            });

            {% if 'space_id' in request.GET %}
                this.spaceInput = {{ space_id }}

                axios
                .get('{% url 'get_space_details' pk=space_id %}')
                .then(response => {
                    this.space = response.data;
                    this.loading = false;
                })
                .catch(error => {
                    console.error(error);
                    this.loading = false;
                });
            {% else %}
                this.noSpaceIdParam = true;
                this.loading = false;
            {% endif %}
        }
    });
</script>
<style>
    .form-content>.form-control {
        height: 150px;
    }

    .form-group .btn {
        margin-top: 18px;
    }

    .alert p {
        margin: 0;
    }

    .card {
        width: 33.3%;
        margin-bottom: 16px;
    }

    .card img {
        height: 200px;
        object-fit: cover;
    }

    .badge {
        margin-bottom: 8px;
        cursor: pointer;
    }

    .card-footer {
        margin-bottom: 16px;
    }
</style>
{% endblock %}