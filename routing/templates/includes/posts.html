<div id="app" class="mt-4">
    <div :class="['mb-5', 'align-items-start', 'd-flex', 'justify-content-between', { 'half-opacity': loading }]">
        <div class="posts-filter-buttons-container d-flex gap-2">
            <span @click="switchPostsFilter('trending')" :class="['badge', 'badge-pill', filter === 'trending' ? 'bg-primary' : 'bg-light', filter !== 'trending' && 'text-dark']">Trending</span>
            <span @click="switchPostsFilter('newest')" :class="['badge', 'badge-pill', filter === 'newest' ? 'bg-primary' : 'bg-light', filter !== 'newest' && 'text-dark']">Newest</span>
            <span @click="switchPostsFilter('oldest')" :class="['badge', 'badge-pill', filter === 'oldest' ? 'bg-primary' : 'bg-light', filter !== 'oldest' && 'text-dark']">Oldest</span>
            <span @click="switchPostsFilter('comments')" :class="['badge', 'badge-pill', filter === 'comments' ? 'bg-primary' : 'bg-light', filter !== 'comments' && 'text-dark']">Most comments</span>
        </div>
        <div class="row">
            <div class="form-group col">
                <vuejs-datepicker v-model="fromDate" placeholder="From date" input-class="form-control"></vuejs-datepicker>
            </div>
            <div class="form-group col">
                <vuejs-datepicker v-model="toDate" placeholder="To date" :class="{ 'half-opacity': !fromDate }" input-class="form-control" :disabled="!fromDate"></vuejs-datepicker>
            </div>
        </div>
    </div>
    <div v-for="post in this.posts" class="post-container card mb-3" :id="'postCard' + post.id">
        <div class="card-body">
            <h5 class="card-title">[[ post.name ]]</h5>
            <p class="card-text text-muted d-flex justify-content-between user-date-container">
                <span class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#6c757d"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z"/></svg>
                    &nbsp;[[ post.user.username ]]
                </span>
                <span class="d-flex align-items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#5f6368"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z"/></svg>
                    &nbsp;[[ convertIso8601Format(post.created_at) ]]
                    <span v-if="!post.created_at === post.updated_at">(Last updated on [[ convertIso8601Format(post.updated_at) ]])</span>
                </span>
            </p>
        </div>
        <div class="card-body">
            <p class="card-text">[[ post.content ]]</p>
        </div>
        <div class="card-body text-muted">
            <span v-for="tag in post.tags" class="badge me-2 bg-primary">
                <svg xmlns="http://www.w3.org/2000/svg" height="17px" viewBox="0 -960 960 960" width="17px" fill="#FFFFFF"><path d="M840-480 666-234q-11 16-28.5 25t-37.5 9H200q-33 0-56.5-23.5T120-280v-400q0-33 23.5-56.5T200-760h400q20 0 37.5 9t28.5 25l174 246Zm-98 0L600-680H200v400h400l142-200Zm-542 0v200-400 200Z" /></svg>
                [[ tag.name ]]
            </span>
        </div>
        {% if not in_space_details %}
            <div v-if="post.space" class="space-container-wrapper">
                <div class="d-inline-block space-container" @click="navigateToSpace(post.space.id)">
                    <div class="d-flex gap-1 align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px" fill="#000000"><path d="M440-183v-274L200-596v274l240 139Zm80 0 240-139v-274L520-457v274Zm-80 92L160-252q-19-11-29.5-29T120-321v-318q0-22 10.5-40t29.5-29l280-161q19-11 40-11t40 11l280 161q19 11 29.5 29t10.5 40v318q0 22-10.5 40T800-252L520-91q-19 11-40 11t-40-11Zm200-528 77-44-237-137-78 45 238 136Zm-160 93 78-45-237-137-78 45 237 137Z"/></svg>
                        <span>[[ post.space.name ]]</span>
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="list-group list-group-flush text-muted">
            <li class="list-group-item d-flex justify-content-between">
                <span @click="toggleCommentsSection(post)" class="cursor-pointer">
                    [[ post.comments_count ]] comments
                </span>
                <div class="rating-container">
                    <div class="d-flex gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="m136-240-56-56 296-298 160 160 208-206H640v-80h240v240h-80v-104L536-320 376-480 136-240Z"/></svg>
                        <div class="vr"></div>
                        <span>[[ (Math.round(post.rating * 100) / 100).toFixed(1) ]] rating</span>
                    </div>
                </div>
                <span>[[ post.reactions_count ]] reactions</span>

                {# [[ post.visibility ]] #}
            </li>
            <li class="list-group-item">
                <div class="row">
                    <div class="col d-flex justify-content-center align-items-center cursor-pointer" @click="toggleCommentsSection(post)">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M240-400h480v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM880-80 720-240H160q-33 0-56.5-23.5T80-320v-480q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v720ZM160-320h594l46 45v-525H160v480Zm0 0v-480 480Z"/></svg>
                    </div>
                    <div class="col reactions d-flex justify-content-center align-items-center">
                        <div v-for="reaction in post.reactions" :key="reaction.id" @click="toggleReaction(reaction, post)" :data-reaction-name="reaction.name" class="reaction-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" :fill="reaction.is_reacted ? '#0d6efd' : '#5f6368'">
                                <path :d="reaction.icon"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </li>
            <div v-if="post.show_comments_section" class="modal d-block modal-custom" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title no-wrap">[[ post.name ]]</h5>
                            <button type="button" class="btn-close" aria-label="Close" @click="toggleCommentsSection(post)"></button>
                        </div>
                        <div class="modal-body comments-container" @scroll="handleCommentsScroll(post, $event)">
                            <div :class="['mb-3', 'btn-group', { 'half-opacity': !post.comments.length }]" role="group" aria-label="Filter options">
                                <button :class="['btn', 'btn-sm', 'btn-outline-primary', { active: post.comment_order == '' }]" @click="switchCommentsOrder('', post)">Newest</button>
                                <button :class="['btn', 'btn-sm', 'btn-outline-primary', { active: post.comment_order == 'oldest' }]" @click="switchCommentsOrder('oldest', post)">Oldest</button>
                                <button :class="['btn', 'btn-sm', 'btn-outline-primary', { active: post.comment_order == 'top' }]" @click="switchCommentsOrder('top', post)">Top</button>
                            </div>
                            <textarea placeholder="Add comment as {{ request.user.username }}..." class="form-control comment-textarea" :id="'commentInput' + post.id" @input="adjustTextAreaHeight"></textarea>
                            <button class="btn btn-primary btn-sm mb-3 mt-3" @click="createComment(post)" :id="'commentButton' + post.id">Publish</button>
                            <comment v-if="post.comments" :comments="post.comments"></comment>
                            <div v-if="post.next_comment_page" class="loading-container d-flex justify-content-center align-items-center">
                                <div v-if="post.loading_comments" class="spinner-border" role="status"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @click="toggleCommentsSection(post)">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="post.show_comments_section" class="modal-backdrop fade show"></div>
        </div>
    </div>
    <div class="loading-container d-flex justify-content-center align-items-center">
        <div v-if="loading" class="spinner-border" role="status"></div>
    </div>
</div>